<!doctype html>
<html>

<head>
  <title>Android Remote Session</title>
  <meta charset="UTF-8" />
  <style>
    .fc {
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .fc>*,
    .fr>* {
      flex: 1;
    }

    .f0 {
      flex: none !important;
    }

    .fr {
      display: flex;
      flex-direction: row;
      align-items: stretch;
    }

    .bb {
      border: 1px solid black;
    }

    #canvas {
      display: inline-block;
    }
  </style>
</head>

<body class='fr'>
  <div class='f0'>
    <canvas class='bb' tabindex="1" id="canvas"></canvas>
  </div>
  <div class='fc'>
    <div class='fr f0'>
      <button tabindex="2" id="power">Power</button>
      <button tabindex="3" id="get-clip">Get Clipboard</button>
      <button tabindex="4" id="set-clip">Set Clipboard</button>
    </div>
    <textarea tabindex="5" id="txt-clip"></textarea>
    <div class='fr f0'>
      <button tabindex="6" id="list-ports">Ports</button>
      <input tabindex='7' id='port-num' />
      <button tabindex="8" id="fwd-port">Fwd</button>
      <button tabindex="9" id="rev-port">Rev</button>
    </div>
    <div class='bb' style='white-space: pre;' id='port-list'>&nbsp;</div>
  </div>
  <script>
    var debug = false;
    /*jshint browser:true*/

    var BLANK_IMG =
      'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='

    var canvas = document.getElementById('canvas')
      , g = canvas.getContext('2d')

    canvas.style.maxHeight = (window.innerHeight - 50) + 'px';

    function wsOnMessage(message) {
      if (typeof message.data === 'string') {
        let j = null;
        try { j = JSON.parse(message.data); } catch (e) { }
        if (j) {
          if (j.type == 'GetClipboardResponse') getClipResponse(j);
          if (j.type == 'ports') getPortsResponse(j);
        }
      } else {
        var blob = new Blob([message.data], { type: 'image/jpeg' })
        var URL = window.URL || window.webkitURL
        var img = new Image()
        img.onload = function () {
          //if(debug) console.log(img.width, img.height)
          canvas.width = img.width
          canvas.height = img.height
          g.drawImage(img, 0, 0)
          img.onload = null
          img.src = BLANK_IMG
          img = null
          u = null
          blob = null
        }
        var u = URL.createObjectURL(blob)
        img.src = u
      }
    }
    var ws;
    function createWs() {
      ws = new WebSocket('ws://' + window.location.host, 'minicap')
      ws.binaryType = 'blob'

      ws.onclose = function () {
        console.log('ws close...try reopen in 2 seconds');
        setTimeout(createWs, 2000);
      }

      ws.onopen = function () { console.log('ws open'); };
      ws.onerror = function () { console.log('ws error', arguments); };

      ws.onmessage = wsOnMessage;

    }
    createWs();

    canvas.mdown = false;
    canvas.debounce = 0;
    function mouseHandler(t, e) {
      var x = e.clientX / canvas.scrollWidth, y = e.clientY / canvas.scrollHeight;
      ws.send(JSON.stringify({ event: 'mouse', t: t, x: x, y: y }));
      if (debug) console.log(t, canvas.mdown, e.clientX, e.clientY, canvas.scrollWidth, canvas.scrollHeight);
    }
    canvas.addEventListener('mousemove', function (e) {
      if (!canvas.mdown) return;
      if (!canvas.debounce) {
        canvas.debounce++;
        mouseHandler('m', e);
        setTimeout(() => {
          canvas.debounce = 0;
        }, 100);
      }
    });
    canvas.addEventListener('mousedown', function (e) {
      canvas.mdown = true;
      mouseHandler('d', e);
    });
    canvas.addEventListener('mouseup', function (e) {
      canvas.mdown = false;
      mouseHandler('u', e);
    });

    function keyHandler(e, isDown) {
      var cl = e.getModifierState('CapsLock');
      var obj = {
        event: 'key', key: e.keyCode,
        mods: [e.shiftKey, e.ctrlKey, e.altKey, e.metaKey, cl], isDown
      }
      var json = JSON.stringify(obj);
      if (debug) console.log(json);
      ws.send(json);
    }
    canvas.addEventListener('keydown', function (e) {
      keyHandler(e, true);
      e.preventDefault();
    });
    canvas.addEventListener('keyup', function (e) {
      keyHandler(e, false);
      e.preventDefault();
    });

    var bPower = document.getElementById('power');
    bPower.onclick = function (e) {
      ws.send(JSON.stringify({ event: 'power' }));
    };

    var getClip = document.getElementById('get-clip');
    var txtClip = document.getElementById('txt-clip');
    var setClip = document.getElementById('set-clip');
    getClip.onclick = function (e) {
      txtClip.allowUpdate = true;
      ws.send(JSON.stringify({ event: 'getclip' }));
    };
    setClip.onclick = function (e) {
      ws.send(JSON.stringify({ event: 'setclip', text: txtClip.value }));
    };
    function getClipResponse(j) {
      if (txtClip.allowUpdate) {
        txtClip.value = j.message.text;
        txtClip.allowUpdate = false;
      }
    }

    var lstPorts = document.getElementById('list-ports');
    var portList = document.getElementById('port-list');
    var fwdPort = document.getElementById('fwd-port');
    var revPort = document.getElementById('rev-port');
    var portNum = document.getElementById('port-num');
    lstPorts.onclick = function () {
      ws.send(JSON.stringify({ event: 'listports' }));
    };
    function getPortsResponse(j) {
      portList.innerHTML = j.data;
    }
    fwdPort.onclick = function () {
      ws.send(JSON.stringify({ event: 'addport', rev: false, port: portNum.value }));
    };
    revPort.onclick = function () {
      ws.send(JSON.stringify({ event: 'addport', rev: true, port: portNum.value }));
    };

  </script>
</body>

</html>